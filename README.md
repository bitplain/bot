# Модульный Telegram-бот (пример)

Пример минималистичного, но расширяемого Telegram-бота на `aiogram 3`, который
реализует первые два модуля: базу знаний сотрудников и простого ИИ-ассистента.
Архитектура допускает простое подключение/отключение модулей через конфигурацию.

## Структура проекта
```
.
├── app
│   ├── core
│   │   ├── db.py              # Инициализация БД и фабрика сессий
│   │   ├── loader.py          # Создание экземпляров Bot/Dispatcher
│   │   └── modules.py         # Подключение модулей по конфигурации
│   ├── models
│   │   ├── __init__.py
│   │   └── knowledge_base.py  # ORM-модель Employee
│   └── modules
│       ├── __init__.py
│       ├── ai_assistant       # Модуль общения с ChatGPT-совместимым API
│       │   ├── __init__.py
│       │   └── handlers.py
│       └── knowledge_base     # Модуль базы знаний сотрудников
│           ├── __init__.py
│           └── handlers.py    # Меню /Co-Fi, диалоги добавления/поиска/удаления/списка
├── config.py                  # Настройки (token, БД, список модулей)
├── main.py                    # Точка входа бота
├── requirements.txt
└── README.md
```

## Установка и запуск
1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Создайте файл `.env` или экспортируйте переменные окружения с токеном бота и
   (опционально) ключом API для ИИ:
   ```bash
   echo "BOT_TOKEN=ВАШ_ТОКЕН" > .env
   # при необходимости задайте нестандартный путь к БД
   # echo "DATABASE_URL=sqlite+aiosqlite:///./knowledge.db" >> .env
   # для ИИ-ассистента (ChatGPT-совместимый API)
   # echo "OPENAI_API_KEY=sk-..." >> .env
   # echo "OPENAI_BASE_URL=https://api.openai.com/v1" >> .env
   # echo "OPENAI_MODEL=gpt-3.5-turbo" >> .env
   ```
3. Запустите бота:
   ```bash
   python main.py
   ```
   При первом старте будут созданы таблицы в SQLite (файл `knowledge.db`).

## Тестирование
Запустите автоматические проверки (пока тестов нет, но команда помогает убедиться,
что окружение настроено корректно):
```bash
pytest
```

## Конфигурация модулей
В `config.py` параметр `enabled_modules` задает список активных модулей.
По умолчанию включены:
- `knowledge_base` — база знаний сотрудников.
- `ai_assistant` — ИИ-ассистент (работает, если указан `OPENAI_API_KEY`).

Чтобы подключить новый модуль, добавьте его имя в список — остальной код
изменять не нужно.

## Функционал модуля базы знаний
- Команда `/Co-Fi` (или `/cofi`) показывает меню с кнопками: добавление,
  поиск, удаление и просмотр списка (по 5 записей с пагинацией).
- Команды `/add` или `/добавить` сразу запускают пошаговый диалог добавления
  сотрудника: фамилия, имя, отчество (опционально), телефон, email,
  должность, отдел. Для телефона и email выполняется валидация формата.
- Поиск принимает произвольный текст (имя, email, отдел, телефон и т.д.) и
  выдаёт совпадения.
- Удаление по ID или email.
- Просмотр списка выводит по 5 сотрудников с навигацией «Назад/Далее».

## Функционал ИИ-модуля
- Команда `/ai <вопрос>` или `/ask <вопрос>` отправляет вопрос в
  ChatGPT-совместимый API (используются параметры `OPENAI_BASE_URL` и
  `OPENAI_MODEL`).
- Если вызвать `/ai` без аргументов, бот попросит ввести вопрос следующим
  сообщением.

## Расширяемость
- Шаблон подключения новых модулей — в `app/core/modules.py`.
- Каждый модуль предоставляет функцию `setup(dispatcher)`, где регистрирует свои роутеры.
- Для примера поиска можно создать `app/modules/search/handlers.py` с функцией `setup`
  и добавить `"search"` в список `enabled_modules`.

## Примечания
- ORM: `SQLAlchemy 2.x` (async, SQLite). Для миграции на PostgreSQL/MySQL
  измените `DATABASE_URL` — остальной код останется прежним.
- FSM: `aiogram 3`.
- Код снабжен комментариями на русском языке для быстрого погружения.
